<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiops.api.mapper.GlobalKpiMapper">

    <select id="selectCrossAxisKpi" resultType="com.aiops.api.entity.vo.response.CrossAxisGraphPoint">
        select `time`, `value`, `predict`
        from kpi_all_${kpiName}_${step}
        where `time` <![CDATA[ >= ]]> #{from}
        and `time` <![CDATA[ <= ]]> #{to};
    </select>


    <select id="selectHeatmap" resultType="com.aiops.api.entity.vo.response.HeatmapPoint">
        SET @rank = -1 ,@rowtotal := NULL;
        SELECT
            CASE
        WHEN @rowtotal = a.`time` THEN
            @rank
        WHEN @rowtotal := a.`time` THEN
            @rank := @rank + 1
        END AS `x`, a.y, a.value, a.predict
        FROM(
            SELECT `time`,  `num_of_steps` AS `y`, `value`, 0.0 AS `predict`
            FROM kpi_all_heatmap_${step}
            WHERE `step` = #{heatmapStep}
            and `time` <![CDATA[ >= ]]> #{from}
            and `time` <![CDATA[ <= ]]> #{to}
            ORDER BY `time`, `y` ASC) a;
    </select>


    <select id="selectTheMostHeatmapStep" resultType="java.lang.Integer">
        select step
        from kpi_all_heatmap_${step}
        where `time` <![CDATA[ >= ]]> #{from}
        and `time` <![CDATA[ <= ]]> #{to}
        group by step
        order by step desc
        limit 1;
    </select>
</mapper>